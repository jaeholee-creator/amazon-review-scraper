name: TikTok Shop Reviews Collection

on:
  schedule:
    # 매일 KST 오전 10시 (UTC 01시)
    - cron: '0 1 * * *'
  workflow_dispatch:  # 수동 실행 허용

jobs:
  collect-tiktok-reviews:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      # Google Sheets 인증 설정
      - name: Create credentials
        run: |
          echo '${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}' > credentials.json

      # Gmail API Service Account 설정 (TikTok 인증 코드 자동 읽기용)
      - name: Create Gmail Service Account credentials
        run: |
          if [ -n "${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}" ]; then
            echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > gmail_service_account.json
            echo "Gmail Service Account 설정 완료"
          else
            echo "Gmail Service Account 미설정 - 쿠키 기반 인증만 사용"
          fi

      # TikTok 쿠키 복원 (사전에 저장된 쿠키)
      - name: Restore TikTok cookies
        run: |
          mkdir -p data/tiktok
          if [ -n "${{ secrets.TIKTOK_COOKIES }}" ]; then
            echo '${{ secrets.TIKTOK_COOKIES }}' | base64 -d > data/tiktok/tiktok_cookies.json
            echo "TikTok 쿠키 복원 완료"
          else
            echo "저장된 TikTok 쿠키 없음 - 로그인 시도"
          fi

      # 환경변수 설정
      - name: Set environment variables
        run: |
          echo "TIKTOK_EMAIL=${{ secrets.TIKTOK_EMAIL }}" >> $GITHUB_ENV
          echo "TIKTOK_PASSWORD=${{ secrets.TIKTOK_PASSWORD }}" >> $GITHUB_ENV
          echo "TIKTOK_HEADLESS=true" >> $GITHUB_ENV
          echo "AMAZON_EMAIL=${{ secrets.AMAZON_EMAIL }}" >> $GITHUB_ENV
          echo "AMAZON_PASSWORD=${{ secrets.AMAZON_PASSWORD }}" >> $GITHUB_ENV
          echo "TIKTOK_GMAIL_SERVICE_ACCOUNT=gmail_service_account.json" >> $GITHUB_ENV
          echo "TIKTOK_GMAIL_DELEGATED_USER=${{ secrets.TIKTOK_GMAIL_DELEGATED_USER }}" >> $GITHUB_ENV

      # TikTok 리뷰 수집 실행
      - name: Run TikTok Shop Review Scraper
        run: python tiktok_daily_scraper.py

      # 로그 업로드 (실패 시)
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: tiktok-scraper-logs
          path: data/tiktok/tiktok_scraper.log
          retention-days: 7

      # 성공 알림
      - name: Success notification
        if: success()
        run: |
          echo "TikTok Shop 리뷰 수집 완료"
          echo "리뷰가 Google Sheets에 업데이트되었습니다"
